# Truth Chain Schema Documentation

## Overview
Complete truth metadata flow from tpstream → TPs → clusters → volumes

---

## 1. Tpstream Files (Input)
**Location**: External production files  
**Trees**:
- `mctruths`: Initial particle info (px, py, pz from generator)
- `mcneutrinos`: Neutrino info (interaction type, energy, momentum)
- `mcparticles`: Geant4 particles
- `simides`: Energy deposits
- `TriggerPrimitives`: Raw TPs

**Key Fields**:
- mctruths: `px`, `py`, `pz` (initial momentum from generator)
- mcneutrinos: `interaction`, `nu_energy`, `nu_px`, `nu_py`, `nu_pz`

---

## 2. TPs Files (After Backtracking)
**Generated by**: `backtrack_tpstream` app  
**Code**: `src/backtracking/Backtracking.cpp`

### Truth Extraction (Backtracking.cpp)
```cpp
// Line 280-330: Read mctruths tree
mc_true_particle.SetPx(px[i]);  // Initial momentum from generator
mc_true_particle.SetPy(py[i]);
mc_true_particle.SetPz(pz[i]);

// Line 485-495: Associate mc_true_particles → true_particles
particle.SetPx(mc_true_particle.GetPx());  // ← MOMENTUM FIX
particle.SetPy(mc_true_particle.GetPy());
particle.SetPz(mc_true_particle.GetPz());

// Line 477: Associate TrueParticles → Neutrinos
particle.SetNeutrino(&neutrino);
```

### TP Truth Storage (TriggerPrimitive.hpp)
```cpp
// Lines 61-63: Particle momentum
particle_px_ = true_particle->GetPx();
particle_py_ = true_particle->GetPy();
particle_pz_ = true_particle->GetPz();

// Lines 65-74: Neutrino info
if (true_particle->GetNeutrino() != nullptr) {
    neutrino_interaction_ = nu->GetInteraction();  // "ES" or "CC"
    neutrino_energy_ = nu->GetEnergy();
    neutrino_px_ = nu->GetPx();
    neutrino_py_ = nu->GetPy();
    neutrino_pz_ = nu->GetPz();
}
```

### TPs ROOT Schema
**Tree**: `tps/tps_tree`  
**Branches** (per TP):
- Channel/time: `detector_channel`, `time_start`, `samples_over_threshold`, `samples_to_peak`
- ADC: `adc_integral`, `adc_peak`
- Particle truth: `particle_energy`, `particle_px`, `particle_py`, `particle_pz`
- Neutrino truth: `neutrino_energy`, `neutrino_px`, `neutrino_py`, `neutrino_pz`, `neutrino_interaction` (string)
- Generator: `generator_name`, `process`

---

## 3. Cluster Files
**Generated by**: `make_clusters` app  
**Code**: `src/clusters/Clustering.cpp`, `src/objects/Cluster.cpp`

### Truth Extraction (Cluster.cpp)
```cpp
// Lines 103-108: Build neutrino_info_map from TPs
struct NeutrinoInfo {
    std::string interaction;
    float energy;
    float px, py, pz;
};
std::map<ParticleKey, NeutrinoInfo> neutrino_info_map;

// Line 149: Extract particle momentum from TPs
true_momentum_ = {tp->GetParticlePx(), tp->GetParticlePy(), tp->GetParticlePz()};

// Lines 201-207: Set cluster truth from dominant particle
if (neutrino_info_map.count(dominant_key) > 0) {
    const auto& nu_info = neutrino_info_map[dominant_key];
    true_neutrino_energy_ = nu_info.energy;
    is_es_interaction_ = (nu_info.interaction == "ES");  // ← BOOLEAN CONVERSION
}
```

### Clusters ROOT Schema (Clustering.cpp)
**Tree**: `clusters/clusters_tree_{U,V,X}`  
**Branches** (per cluster):
- Event: `event`, `n_tps`
- Truth position: `true_pos_x`, `true_pos_y`, `true_pos_z`
- Truth momentum: `true_mom_x`, `true_mom_y`, `true_mom_z`  ← **NOW POPULATED**
- Truth energy: `true_neutrino_energy`, `true_particle_energy`
- **Interaction**: `is_es_interaction` (bool, O type)  ← **CHANGED FROM STRING**
- Classification: `true_label`, `true_pdg`, `is_main_cluster`
- Fractions: `supernova_tp_fraction`, `generator_tp_fraction`, `marley_tp_fraction`
- Charge/energy: `total_charge`, `total_energy`
- TP arrays: `tp_detector_channel`, `tp_time_start`, `tp_adc_integral`, `tp_adc_peak`, 
  `tp_samples_over_threshold`, `tp_samples_to_peak`, `tp_simide_energy`

**Key Changes**:
- ✅ `is_es_interaction` (bool) replaces `true_interaction` (string)
- ✅ `true_mom_x/y/z` now have actual momentum values (not 0)

---

## 4. Volume Files (NPZ Arrays)
**Generated by**: `create_volumes.py`  
**Code**: `scripts/create_volumes.py`

### Volume NPZ Schema
**Files**: `<basename>_plane{U,V,X}_volume{idx:03d}.npz`

**Arrays**:
- `image`: 2D numpy array (channels × time_ticks), ADC values with pentagon interpolation
- `metadata`: Dict containing:
  - `event`: Event number
  - `plane`: 'U', 'V', or 'X'
  - `interaction_type`: "ES", "CC", or "Background" (from is_es_interaction bool)
  - `particle_energy`: Electron/particle energy (MeV)
  - `main_track_momentum`: Momentum magnitude sqrt(px²+py²+pz²)
  - `main_track_momentum_x/y/z`: Momentum components
  - `n_clusters_in_volume`: Total clusters in 1m × 1m volume
  - `n_marley_clusters`: Marley (signal) clusters
  - `n_non_marley_clusters`: Background clusters
  - `center_channel`, `center_time_tpc`: Volume center
  - `volume_size_cm`: Physical size (100 cm)
  - `image_shape`: Array dimensions

### Metadata Extraction (create_volumes.py)
```python
# Line 156: Read is_es_interaction boolean from ROOT
'is_es_interaction': bool(arrays['is_es_interaction'][i])

# Lines 377-389: Convert boolean to display string
is_es = main_cluster['is_es_interaction']
if main_cluster['is_marley']:
    event_energy = main_cluster['true_particle_energy']
    interaction_type = "ES" if is_es else "CC"
else:
    event_energy = -1.0
    interaction_type = "Background"
```

---

## Data Flow Summary

```
tpstream.root (production)
├─ mctruths: px, py, pz (initial momentum)
├─ mcneutrinos: interaction ("ES"/"CC"), energy, px, py, pz
├─ mcparticles: track_id, pdg
├─ simides: energy deposits
└─ TriggerPrimitives: raw TPs

    ↓ [Backtracking with momentum fix]

tps.root
├─ Each TP stores:
├─── Particle: energy, px, py, pz ✅ (from mctruths via mc_true_particles)
├─── Neutrino: energy, px, py, pz, interaction (string "ES"/"CC")
└─── Generator: name, process

    ↓ [Clustering extracts from TPs]

clusters.root
├─ Each cluster stores:
├─── Particle momentum: true_mom_x/y/z ✅ (from TPs)
├─── Neutrino energy: true_neutrino_energy ✅
├─── Interaction: is_es_interaction (bool) ✅ (converted from string)
├─── All TPs with full data (channels, times, ADC)
└─── Metadata: label, PDG, fractions, is_main_cluster

    ↓ [Volume creation aggregates clusters]

volume_*.npz
├─ image: 2D array (1m × 1m, pentagon interpolation)
└─ metadata:
    ├─── interaction_type: "ES"/"CC"/"Background" (from bool)
    ├─── particle_energy: Electron energy
    ├─── main_track_momentum: sqrt(px²+py²+pz²) ✅
    ├─── main_track_momentum_x/y/z ✅
    ├─── n_marley_clusters, n_non_marley_clusters
    └─── center, size, shape info
```

---

## Verification Steps

### 1. Check TPs file has momentum
```python
import uproot
f = uproot.open("data/tps_bktr3.root")
tree = f["tps/tps_tree"]
arrays = tree.arrays(["particle_px", "particle_py", "particle_pz"], library="np")
# Should see non-zero momentum values (not all 0)
```

### 2. Check clusters file has boolean interaction
```python
f = uproot.open("data/clusters_tick3_ch2_min2_tot1.root")
tree = f["clusters/clusters_tree_X"]
arrays = tree.arrays(["is_es_interaction", "true_mom_x"], library="np")
# is_es_interaction should be boolean (True/False)
# true_mom_x should have non-zero values
```

### 3. Check volume NPZ has complete metadata
```python
data = np.load("data/volume_000.npz")
metadata = data['metadata'][0]
# Should have interaction_type, particle_energy, main_track_momentum, etc.
```

---

## CLI Options for Production

### Backtracking
```bash
# Standard
./build/src/app/backtrack_tpstream -j json/config.json

# Custom margin
./build/src/app/backtrack_tpstream -j json/config.json -m 5
```

### Clustering
```bash
# Standard
./build/src/app/make_clusters -j json/config.json

# With verbosity
./build/src/app/make_clusters -j json/config.json -v
```

### Volume Creation
```bash
# Standard
./scripts/create_volumes.sh -j json/config.json

# With CLI overrides (NEW!)
./scripts/create_volumes.sh -j json/config.json --skip 100 --max 50 -v
```

---

## File Locations

### Source Code
- **Backtracking**: `src/backtracking/Backtracking.cpp`
- **TP Schema**: `src/objects/TriggerPrimitive.hpp`
- **Clustering**: `src/clusters/Clustering.cpp`
- **Cluster Schema**: `src/objects/Cluster.{h,cpp}`
- **Volume Creation**: `scripts/create_volumes.py`
- **Bash Wrapper**: `scripts/create_volumes.sh`

### Configuration
- **JSON configs**: `json/`
- **Parameters**: `parameters/geometry.dat`, `parameters/timing.dat`

---

## Recent Fixes (Commit 0f96bb2)

1. ✅ **Momentum propagation**: Copy px/py/pz from mc_true_particles to true_particles
2. ✅ **Boolean interaction**: Changed from string to bool is_es_interaction throughout
3. ✅ **CLI options**: Added --skip and --max to bash scripts
4. ✅ **Data cleanup**: Deleted 26,152 old files for regeneration

All changes tested, compiled, and pushed to `evilla/direct-tp-simide-matching` branch.
